FIND_PROGRAM(GETTEXT_XGETTEXT_EXECUTABLE xgettext)

IF (NOT GETTEXT_FOUND)
   MESSAGE(STATUS "gettext not found")
ENDIF()
IF (NOT GETTEXT_XGETTEXT_EXECUTABLE)
   MESSAGE(STATUS "xgettext not found (package gettext)")
ENDIF()
IF (NOT GETTEXT_MSGMERGE_EXECUTABLE)
   MESSAGE(STATUS "msgmerge not found (package gettext)")
ENDIF()
IF (NOT GETTEXT_MSGFMT_EXECUTABLE)
   MESSAGE(STATUS "msgfmt not found (package gettext)")
ENDIF()

MACRO(GETTEXT_UPDATE_POT target _potFile)
	ADD_CUSTOM_TARGET(${target} COMMAND ${GETTEXT_XGETTEXT_EXECUTABLE} -o ${_potFile} ${ARGN})
ENDMACRO(GETTEXT_UPDATE_POT)

MACRO(GETTEXT_MERGE_PO target _potFile)
	SET(_cmds)
	FOREACH (_currentPoFile ${ARGN})
		SET(_cmds ${_cmds} COMMAND ${GETTEXT_MSGMERGE_EXECUTABLE} --update --backup=none -s ${_currentPoFile} ${_potFile} -v )
	ENDFOREACH (_currentPoFile )
	ADD_CUSTOM_TARGET(${target} ${_cmds})
ENDMACRO(GETTEXT_MERGE_PO)

MACRO(GETTEXT_INSTALL_PO basename)
	SET(_moFiles)
	SET(_addToAll)
	IF (GETTEXT_FOUND)
		SET(_addToAll "ALL")
	ENDIF()
	IF (APPLE)
		file(MAKE_DIRECTORY ${CMAKE_BINARY_DIR}/${PROJECT_NAME}.app/Contents/Resources/en.lproj)
		INSTALL(CODE "FILE(MAKE_DIRECTORY /${ENV}/${CMAKE_INSTALL_PREFIX}/${PROJECT_NAME}.app/Contents/Resources/en.lproj)")
	ENDIF ()
	FOREACH (_currentPoFile ${ARGN})
		GET_FILENAME_COMPONENT(_lang ${_currentPoFile} NAME_WE)
		IF (WIN32)
			SET(_moDir ${CMAKE_BINARY_DIR}/bin/${_lang})
		ELSEIF (APPLE)
			SET(_moDir ${CMAKE_BINARY_DIR}/${PROJECT_NAME}.app/Contents/Resources/${_lang}.lproj)
		ELSE()
			SET(_moDir ${CMAKE_BINARY_DIR}/share/locale/${_lang}/LC_MESSAGES)
		ENDIF()
		IF (APPLE)
			SET(_moFile ${_moDir}/${PROJECT_NAME}.mo)
		ELSE ()
			SET(_moFile ${_moDir}/${basename}.mo)
		ENDIF ()
		SET(_moFiles ${_moFiles} ${_moFile})
		file(MAKE_DIRECTORY ${_moDir})

		ADD_CUSTOM_COMMAND( 
			OUTPUT ${_moFile} 
			COMMAND ${GETTEXT_MSGFMT_EXECUTABLE} -o ${_moFile} ${_currentPoFile}
			DEPENDS ${_currentPoFile} 
		)
		IF (GETTEXT_FOUND)
			IF (WIN32)
			   INSTALL(FILES ${_moFile} DESTINATION bin/${_lang} RENAME ${basename}.mo)
			ELSEIF (APPLE)
			   INSTALL(FILES ${_moFile} DESTINATION ${_lang}.lproj RENAME ${PROJECT_NAME}.mo)
			ELSE()
			   INSTALL(FILES ${_moFile} DESTINATION share/locale/${_lang}/LC_MESSAGES RENAME ${basename}.mo)
			ENDIF()
		ENDIF()
	ENDFOREACH (_currentPoFile )

	ADD_CUSTOM_TARGET(translations ${_addToAll} DEPENDS ${_moFiles})
ENDMACRO(GETTEXT_INSTALL_PO)
